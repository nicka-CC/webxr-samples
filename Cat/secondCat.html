<!DOCTYPE html>
<html>
<head>
  <meta charset='utf-8'>
  <meta name='viewport' content='width=device-width, initial-scale=1'>
  <meta name='mobile-web-app-capable' content='yes'>
  <meta name='apple-mobile-web-app-capable' content='yes'>
  <title>AR Котики</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: black;
      overflow: hidden;
    }

    canvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
    }
    #info {
      position: fixed;
      top: 10px;
      left: 10px;
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 10px;
      border-radius: 5px;
      font-family: monospace;
      z-index: 3;
      font-size: 12px;
      max-width: 300px;
    }
    #info h3 {
      margin: 0 0 10px 0;
      color: #4CAF50;
    }
    #info p {
      margin: 5px 0;
    }
    #info .status {
      color: #4CAF50;
    }
    #info .error {
      color: #f44336;
    }
  </style>
  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
      }
    }
  </script>
  <script type="module">
    import * as THREE from 'three';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
    import { ARButton } from 'three/addons/webxr/ARButton.js';

    function logToScreen(msg) {
      const info = document.getElementById('info');
      if (info) {
        info.innerHTML += `<p style="color:yellow">${msg}</p>`;
      }
    }

    let camera, scene, renderer;
    let model, mixer, currentAnimation;
    let clock = new THREE.Clock();
    let animations = [];
    let audioElement = null;
    let startTime = 0;
    let isRotating = false;
    let lastHitPosition = null;
    let rotationSpeed = 15;

    init();
    animate();

    function init() {
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x000000);

      // Аудио
      audioElement = new Audio('./mp3.mp3');
      audioElement.loop = false;
      audioElement.volume = 1.0;

      // Камера
      camera = new THREE.PerspectiveCamera(90, window.innerWidth / window.innerHeight, 0.01, 120);
      camera.position.set(0, 0, 3);

      // Рендерер
      renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      renderer.setPixelRatio(window.devicePixelRatio);
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.xr.enabled = true;
      renderer.outputEncoding = THREE.sRGBEncoding;
      renderer.shadowMap.enabled = true;
      renderer.shadowMap.type = THREE.PCFSoftShadowMap;
      renderer.toneMapping = THREE.ACESFilmicToneMapping;
      renderer.toneMappingExposure = 1.0;
      document.body.appendChild(renderer.domElement);

      // Свет
      const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1);
      light.position.set(0.5, 1, 0.25);
      scene.add(light);
      const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
      directionalLight.position.set(1, 1, 1);
      scene.add(directionalLight);

      // Инфо
      const infoDiv = document.createElement('div');
      infoDiv.id = 'info';
      infoDiv.innerHTML = `
         <h3>AR Котики</h3>
        <p>Статус: <span id="status">Загрузка...</span></p>
        <p>Анимации: <span id="animations">Проверка...</span></p>
        <p>AR статус: <span id="ar-status">Ожидание...</span></p>
      `;
      document.body.appendChild(infoDiv);

      // Модель и анимации
      const loader = new GLTFLoader();
      loader.load(
        './Cate.glb',
        function (gltf) {
          model = gltf.scene;
          model.scale.set(2.5, 2.5, 2.5);
          model.position.set(0, -1000, -1000);
          model.visible = false;
          model.traverse((child) => {
            if (child.isMesh && child.material) {
              child.material.roughness = 1.0;
              child.material.metalness = 0.0;
              child.material.envMapIntensity = 0.0;
              child.material.needsUpdate = true;
              child.castShadow = true;
              child.receiveShadow = true;
            }
          });
          scene.add(model);
          mixer = new THREE.AnimationMixer(model);
          animations = gltf.animations;
          logToScreen('Модель загружена, анимаций: ' + animations.length);
          if (animations && animations.length > 0) {
            animations.forEach((clip, idx) => {
              logToScreen('Клип #' + idx + ': ' + clip.name + ', треков: ' + clip.tracks.length);
              logToScreen('Треки: ' + clip.tracks.map(t => t.name).join(', '));
            });
          }
          if (animations && animations.length > 0) {
            document.getElementById('animations').textContent = `Найдено: ${animations.length}`;
            document.getElementById('status').textContent = 'Готово';
            // Запускаем все анимации синхронно
            animations.forEach((clip, idx) => {
              const action = mixer.clipAction(clip);
              action.reset();
              action.setLoop(THREE.LoopRepeat);
              action.clampWhenFinished = false;
              action.timeScale = 1.0;
              action.play();
              logToScreen('Анимация #' + idx + ' (' + clip.name + ') запущена');
            });
          } else {
            document.getElementById('animations').textContent = 'Не найдено';
            document.getElementById('status').textContent = 'Нет анимаций';
            logToScreen('Анимаций не найдено!');
          }

          // Жесты
          renderer.domElement.addEventListener('touchstart', onTouchStart, false);
          renderer.domElement.addEventListener('touchmove', onTouchMove, false);
          renderer.domElement.addEventListener('touchend', onTouchEnd, false);
        },
        function (xhr) {
          document.getElementById('status').textContent = `Загрузка: ${(xhr.loaded / xhr.total * 100).toFixed(0)}%`;
        },
        function (error) {
          document.getElementById('status').textContent = 'Ошибка загрузки';
          logToScreen('Ошибка загрузки модели: ' + error);
        }
      );

      // ARButton
      if (navigator.xr && navigator.xr.isSessionSupported) {
        navigator.xr.isSessionSupported('immersive-ar').then(async (supported) => {
          if (supported) {
            try {
              const session = await navigator.xr.requestSession('immersive-ar', { requiredFeatures: ['hit-test'] });
              renderer.xr.setSession(session);
              document.getElementById('ar-status').textContent = 'AR запущен автоматически';
              renderer.xr.addEventListener('sessionstart', function() {
                logToScreen('AR sessionstart');
                document.getElementById('ar-status').textContent = 'AR активен';
                startTime = Date.now();
                clock.start();
                if (audioElement && audioElement.paused) {
                  audioElement.currentTime = 0;
                  audioElement.play().catch(() => {});
                }
                // Сброс и запуск всех анимаций с начала
                if (mixer && animations && animations.length > 0) {
                  animations.forEach((clip, idx) => {
                    const action = mixer.clipAction(clip);
                    action.stop();
                    action.reset();
                    action.setLoop(THREE.LoopRepeat);
                    action.clampWhenFinished = false;
                    action.timeScale = 1.0;
                    action.play();
                    logToScreen('AR: Анимация #' + idx + ' (' + clip.name + ') сброшена и запущена с начала');
                  });
                  logToScreen('mixer: ' + (mixer ? 'есть' : 'нет') + ', animations: ' + animations.length);
                } else {
                  logToScreen('AR: mixer или animations не определены');
                }
              });
              renderer.xr.addEventListener('sessionend', function() {
                logToScreen('AR sessionend');
                document.getElementById('ar-status').textContent = 'AR неактивен';
                clock.stop();
                // Остановить все анимации
                if (mixer && animations && animations.length > 0) {
                  animations.forEach((clip) => {
                    const action = mixer.clipAction(clip);
                    action.stop();
                  });
                  logToScreen('AR: Все анимации остановлены');
                }
                if (audioElement && !audioElement.paused) {
                  audioElement.pause();
                }
              });
            } catch (e) {
              logToScreen('Ошибка запуска AR: ' + e);
              const arBtn = ARButton.createButton(renderer);
              document.body.appendChild(arBtn);
              document.getElementById('ar-status').textContent = 'AR доступен, нажмите кнопку';
            }
          } else {
            const arBtn = ARButton.createButton(renderer);
            document.body.appendChild(arBtn);
            document.getElementById('ar-status').textContent = 'AR не поддерживается';
          }
        });
      } else {
        const arBtn = ARButton.createButton(renderer);
        document.body.appendChild(arBtn);
        document.getElementById('ar-status').textContent = 'WebXR не поддерживается';
      }
      window.addEventListener('resize', onWindowResize);
    }

    function onWindowResize() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function onTouchStart(event) {
      event.preventDefault();
      isRotating = true;
      lastHitPosition = {
        x: event.touches[0].clientX,
        y: event.touches[0].clientY
      };
    }
    function onTouchMove(event) {
      event.preventDefault();
      if (!isRotating || !model) return;
      const touch = event.touches[0];
      const deltaX = touch.clientX - lastHitPosition.x;
      const deltaY = touch.clientY - lastHitPosition.y;
      model.rotation.y += deltaX * rotationSpeed;
      model.rotation.x += deltaY * rotationSpeed;
      model.rotation.x = Math.max(-Math.PI/2, Math.min(Math.PI/2, model.rotation.x));
      lastHitPosition = {
        x: touch.clientX,
        y: touch.clientY
      };
    }
    function onTouchEnd(event) {
      event.preventDefault();
      isRotating = false;
    }

    function animate() {
      renderer.setAnimationLoop(function() {
        logToScreen('animate: xr.isPresenting=' + renderer.xr.isPresenting + ', mixer=' + (mixer ? 'есть' : 'нет'));
        if (renderer.xr.isPresenting && model) {
          model.visible = true;
          model.position.set(0, -10, -16);
          if (mixer && currentAnimation) {
            if (!currentAnimation.isRunning()) {
              currentAnimation.reset();
              currentAnimation.play();
            }
            const delta = clock.getDelta();
            mixer.update(delta);
          }
          if (audioElement && audioElement.paused) {
            audioElement.currentTime = 0;
            audioElement.play().catch(() => {});
          }
        } else if (model) {
          model.visible = false;
          model.position.set(0, -1000, -1000);
          if (currentAnimation && currentAnimation.isRunning()) {
            currentAnimation.stop();
          }
          if (audioElement && !audioElement.paused) {
            audioElement.pause();
          }
        }
        renderer.render(scene, camera);
      });
    }
  </script>
</head>
<body>
</body>
</html>