<!DOCTYPE html>
<html>
<head>
  <meta charset='utf-8'>
  <meta name='viewport' content='width=device-width, initial-scale=1'>
  <meta name='mobile-web-app-capable' content='yes'>
  <meta name='apple-mobile-web-app-capable' content='yes'>
  <title>AR Котики</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: black;
      overflow: hidden;
    }

    canvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
    }
    #info {
      position: fixed;
      top: 10px;
      left: 10px;
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 10px;
      border-radius: 5px;
      font-family: monospace;
      z-index: 3;
      font-size: 12px;
      max-width: 300px;
    }
    #info h3 {
      margin: 0 0 10px 0;
      color: #4CAF50;
    }
    #info p {
      margin: 5px 0;
    }
    #info .status {
      color: #4CAF50;
    }
    #info .error {
      color: #f44336;
    }
  </style>
  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
      }
    }
  </script>
  <script type="module">
    import * as THREE from 'three';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
    import { ARButton } from 'three/addons/webxr/ARButton.js';

    let camera, scene, renderer;
    let model, mixer;
    let clock = new THREE.Clock();
    let currentAnimation = null;
    let animations = [];
    let hitTestSource = null;
    let hitTestSourceRequested = false;
    let isRotating = false;
    let lastHitPosition = null;
    let rotationSpeed = 15;
    let moveSpeed = 0.1;
    let startTime = 0;
    let audioElement = null;
    let lookAtViewerTime = 0;
    let movementState = 'moving';
    let modelPlaced = false;
    let referenceSpace = null;

    init();
    animate();

    function init() {
      // Создаем сцену
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x000000);

      // Создаем аудио элемент
      audioElement = new Audio('./hhhh.mp3');
      audioElement.loop = false;
      audioElement.volume = 1.0;

      // Создаем камеру
      camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 100);
      camera.position.set(0, 1.6, 3); // Устанавливаем камеру на уровне глаз

      // Создаем рендерер
      renderer = new THREE.WebGLRenderer({ 
        antialias: true, 
        alpha: true,
        powerPreference: 'high-performance'
      });
      renderer.setPixelRatio(window.devicePixelRatio);
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.xr.enabled = true;
      renderer.outputEncoding = THREE.sRGBEncoding;
      renderer.shadowMap.enabled = true;
      renderer.shadowMap.type = THREE.PCFSoftShadowMap;
      renderer.toneMapping = THREE.ACESFilmicToneMapping;
      renderer.toneMappingExposure = 1.0;
      document.body.appendChild(renderer.domElement);

      // Добавляем освещение
      const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
      scene.add(ambientLight);

      const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
      directionalLight.position.set(1, 1, 1);
      directionalLight.castShadow = true;
      scene.add(directionalLight);

      // Создаем информационное окно
      const infoDiv = document.createElement('div');
      infoDiv.id = 'info';
      infoDiv.innerHTML = `
        <h3>AR Котики</h3>
        <p>Статус: <span id="status">Загрузка...</span></p>
        <p>Анимации: <span id="animations">Проверка...</span></p>
        <p>AR статус: <span id="ar-status">Ожидание...</span></p>
        <p>Ошибки: <span id="errors" style="color: red;"></span></p>
        <p>Управление:</p>
        <p>- Перетаскивание: Вращение</p>
        <p>- Двойной тап: Пауза/Воспроизведение</p>
        <p>- Наведите камеру на поверхность для размещения кота</p>
      `;
      document.body.appendChild(infoDiv);

      // Функция для отображения ошибок
      function showError(message) {
        const errorsElement = document.getElementById('errors');
        errorsElement.textContent = message;
        console.error(message);
      }

      // Загружаем модель
      const loader = new GLTFLoader();
      showError('Начинаем загрузку модели...');
      loader.load(
              './walk2.glb',
              function (gltf) {
                showError('Модель успешно загружена');
                model = gltf.scene;
                model.scale.set(0.5, 0.5, 0.5);
                model.visible = false;
                scene.add(model);
                showError('Модель добавлена на сцену');

                // Проверяем материалы модели
                model.traverse((child) => {
                  if (child.isMesh && child.material) {
                    showError('Найден меш: ' + child.name);
                    const material = child.material;
                    material.roughness = 0.5;
                    material.metalness = 0.0;
                    material.envMapIntensity = 1.0;
                    material.needsUpdate = true;
                    child.castShadow = true;
                    child.receiveShadow = true;
                  }
                });

                // Настраиваем анимации
                mixer = new THREE.AnimationMixer(model);
                animations = gltf.animations;
                showError('Анимации загружены: ' + (animations ? animations.length : 0));

                if (animations && animations.length > 0) {
                  document.getElementById('animations').textContent = `Найдено: ${animations.length}`;
                  document.getElementById('status').textContent = 'Готово';
                  currentAnimation = mixer.clipAction(animations[0]);
                  currentAnimation.setLoop(THREE.LoopRepeat);
                  currentAnimation.clampWhenFinished = false;
                  currentAnimation.play();
                  showError('Анимация запущена');
                } else {
                  document.getElementById('animations').textContent = 'Не найдено';
                  document.getElementById('status').textContent = 'Нет анимаций';
                  showError('Анимации не найдены в модели');
                }

                // Инициализируем обработчики тач-событий
                renderer.domElement.addEventListener('touchstart', onTouchStart, false);
                renderer.domElement.addEventListener('touchmove', onTouchMove, false);
                renderer.domElement.addEventListener('touchend', onTouchEnd, false);

                // Добавляем обработчики для AR
                renderer.xr.addEventListener('sessionstart', function() {
                  showError('AR сессия началась');
                  document.getElementById('ar-status').textContent = 'AR активен';
                  startTime = Date.now();
                  clock.start();

                  // Запрашиваем hit test source
                  const session = renderer.xr.getSession();
                  session.requestReferenceSpace('viewer').then((space) => {
                    referenceSpace = space;
                    session.requestHitTestSource({ space: referenceSpace }).then((source) => {
                      hitTestSource = source;
                      hitTestSourceRequested = true;
                      showError('Hit test source получен');
                    }).catch(error => {
                      showError('Ошибка получения hit test source: ' + error.message);
                    });
                  }).catch(error => {
                    showError('Ошибка получения reference space: ' + error.message);
                  });
                });

                renderer.xr.addEventListener('sessionend', function() {
                  showError('AR сессия закончилась');
                  document.getElementById('ar-status').textContent = 'AR неактивен';
                  hitTestSource = null;
                  hitTestSourceRequested = false;
                  isRotating = false;
                  lastHitPosition = null;
                  clock.stop();
                });

                // Обработка жестов в AR
                renderer.xr.addEventListener('selectstart', function() {
                  isRotating = true;
                  console.log('Начало вращения');
                });

                renderer.xr.addEventListener('selectend', function() {
                  isRotating = false;
                  lastHitPosition = null;
                  console.log('Конец вращения');
                });

                // Обработка движения в AR
                renderer.xr.addEventListener('inputsourceschange', function(event) {
                  event.added.forEach((inputSource) => {
                    inputSource.addEventListener('selectstart', () => {
                      isRotating = true;
                      console.log('Начало вращения');
                    });
                    inputSource.addEventListener('selectend', () => {
                      isRotating = false;
                      lastHitPosition = null;
                      console.log('Конец вращения');
                    });
                  });
                });
              },
              function (xhr) {
                const progress = (xhr.loaded / xhr.total * 100).toFixed(0);
                document.getElementById('status').textContent = `Загрузка: ${progress}%`;
                showError(`Загрузка модели: ${progress}%`);
              },
              function (error) {
                document.getElementById('status').textContent = 'Ошибка загрузки';
                showError('Ошибка загрузки модели: ' + error.message);
              }
      );

      // Добавляем кнопку AR
      document.body.appendChild(ARButton.createButton(renderer));

      // Обработка изменения размера окна
      window.addEventListener('resize', onWindowResize, false);
    }

    function onWindowResize() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function onTouchStart(event) {
      event.preventDefault();
      isRotating = true;
      lastHitPosition = {
        x: event.touches[0].clientX,
        y: event.touches[0].clientY
      };
    }

    function onTouchMove(event) {
      event.preventDefault();
      if (!isRotating || !model) return;

      const touch = event.touches[0];
      const deltaX = touch.clientX - lastHitPosition.x;
      const deltaY = touch.clientY - lastHitPosition.y;

      model.rotation.y += deltaX * rotationSpeed;
      model.rotation.x += deltaY * rotationSpeed;

      // Ограничиваем вращение по X
      model.rotation.x = Math.max(-Math.PI/2, Math.min(Math.PI/2, model.rotation.x));

      lastHitPosition = {
        x: touch.clientX,
        y: touch.clientY
      };
    }

    function onTouchEnd(event) {
      event.preventDefault();
      isRotating = false;
    }

    function animate() {
      renderer.setAnimationLoop(function() {
        if (model && renderer.xr.isPresenting) {
          const elapsedTime = (Date.now() - startTime) / 1000;

          // Обработка hit-test
          if (hitTestSourceRequested === false) {
            const session = renderer.xr.getSession();
            if (session) {
              session.requestReferenceSpace('viewer').then((referenceSpace) => {
                session.requestHitTestSource({ space: referenceSpace }).then((source) => {
                  hitTestSource = source;
                  hitTestSourceRequested = true;
                });
              });
            }
          }

          if (hitTestSource) {
            const frame = renderer.xr.getFrame();
            const hitTestResults = frame.getHitTestResults(hitTestSource);

            // Добавляем логирование для отладки
            showError(`Hit test source active. Results count: ${hitTestResults.length}. Model placed: ${modelPlaced}`);

            if (hitTestResults.length > 0 && !modelPlaced) {
              const hit = hitTestResults[0];
              const pose = hit.getPose(referenceSpace);
              
              if (pose) {
                // Размещаем модель на поверхности
                model.position.set(
                  pose.transform.position.x,
                  pose.transform.position.y,
                  pose.transform.position.z
                );
                model.visible = true;
                modelPlaced = true;
                document.getElementById('status').textContent = 'Кот размещен';
                showError('Модель успешно размещена на поверхности');
              } else {
                showError('Pose не получен из hit-тест результата.');
              }
            } else if (hitTestResults.length === 0) {
              showError('Нет hit-тест результатов. Продолжаем поиск поверхности.');
            } else if (modelPlaced) {
              showError('Модель уже размещена. Новые hit-тест результаты игнорируются.');
            }
          } else {
            showError('Hit test source неактивен или не получен.');
          }

          // Остальная логика анимации
          if (modelPlaced) {
            if (elapsedTime < 3) {
              // Движение влево
              model.rotation.y = Math.PI / 2 + Math.PI;
              model.position.x -= moveSpeed;
            } else if (elapsedTime < 5) {
              // Пауза и поворот к зрителю после движения влево
              model.rotation.y = 0; // Поворот лицом к зрителю
              
              // Останавливаем анимацию в начале паузы
              if (mixer && currentAnimation && elapsedTime < 4) {
                  currentAnimation.stop();
                  currentAnimation = null;
              }
              
              // Возобновляем анимацию в конце паузы
              if (mixer && animations.length > 0 && !currentAnimation && elapsedTime >= 4) {
                  currentAnimation = mixer.clipAction(animations[0]);
                  currentAnimation.setLoop(THREE.LoopRepeat);
                  currentAnimation.play();
              }
              
              // Воспроизводим звук
              if (audioElement && audioElement.paused) {
                audioElement.currentTime = 0;
                audioElement.play().catch(error => {
                  console.error('Ошибка воспроизведения звука:', error);
                });
              }
            } else if (elapsedTime < 8) {
              // Движение вправо
              model.rotation.y = -Math.PI / 2 + Math.PI;
              model.position.x += moveSpeed;
              // Убедимся, что анимация запущена
              if (mixer && animations.length > 0 && !currentAnimation) {
                  currentAnimation = mixer.clipAction(animations[0]);
                  currentAnimation.setLoop(THREE.LoopRepeat);
                  currentAnimation.play();
              }
            } else if (elapsedTime < 10) {
              // Пауза и поворот к зрителю после движения вправо
              model.rotation.y = 0; // Поворот лицом к зрителю
              // Останавливаем анимацию
              if (mixer && currentAnimation) {
                  currentAnimation.stop();
                  currentAnimation = null;
              }
            } else {
              // Сбрасываем время для повторения цикла
              startTime = Date.now();
              // Возобновляем анимацию
              if (mixer && animations.length > 0 && !currentAnimation) {
                  currentAnimation = mixer.clipAction(animations[0]);
                  currentAnimation.setLoop(THREE.LoopRepeat);
                  currentAnimation.play();
              }
            }
          }

          // Обновляем анимации
          if (mixer) {
            mixer.update(clock.getDelta());
          }
        }

        renderer.render(scene, camera);
      });
    }
  </script>
</head>
<body>
</body>
</html>