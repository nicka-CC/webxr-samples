<!DOCTYPE html>
<html>
<head>
  <meta charset='utf-8'>
  <meta name='viewport' content='width=device-width, initial-scale=1'>
  <meta name='mobile-web-app-capable' content='yes'>
  <meta name='apple-mobile-web-app-capable' content='yes'>
  <title>AR Котики</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: black;
      overflow: hidden;
    }
    canvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
    }
    #info {
      position: fixed;
      top: 10px;
      left: 10px;
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 10px;
      border-radius: 5px;
      font-family: monospace;
      z-index: 3;
      font-size: 12px;
      max-width: 300px;
    }
    #info h3 {
      margin: 0 0 10px 0;
      color: #4CAF50;
    }
    #info p {
      margin: 5px 0;
    }
    #info .status {
      color: #4CAF50;
    }
    #info .error {
      color: #f44336;
    }
  </style>
  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
      }
    }
  </script>
  <script type="module">
    import * as THREE from 'three';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
    import { ARButton } from 'three/addons/webxr/ARButton.js';

    let camera, scene, renderer;
    let model, mixer;
    let clock = new THREE.Clock();
    let currentAnimation = null;
    let animations = [];
    let hitTestSource = null;
    let hitTestSourceRequested = false;
    let isRotating = false;
    let lastHitPosition = null;
    let rotationSpeed = 5;
    let moveSpeed = 0.01;
    let startTime = 0;
    let audioElement = null;
    let currentDirection = 'left'; // 'left' или 'right'
    let distanceTraveled = 0;
    let isLookingAtViewer = false;
    let lookAtViewerTime = 0;

    init();
    animate();

    function init() {
      // Создаем сцену
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x000000);

      // Создаем аудио элемент
      audioElement = new Audio('./hhhh.mp3');
      audioElement.loop = false;
      audioElement.volume = 1.0;

      // Создаем камеру
      camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
      camera.position.set(0, 1.6, 3);

      // Создаем рендерер
      renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      renderer.setPixelRatio(window.devicePixelRatio);
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.xr.enabled = true;
      renderer.outputEncoding = THREE.sRGBEncoding;
      renderer.shadowMap.enabled = true;
      renderer.shadowMap.type = THREE.PCFSoftShadowMap;
      renderer.toneMapping = THREE.ACESFilmicToneMapping;
      renderer.toneMappingExposure = 1.0;
      document.body.appendChild(renderer.domElement);

      // Добавляем свет
      const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
      scene.add(ambientLight);

      const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
      directionalLight.position.set(5, 5, 5);
      scene.add(directionalLight);

      // Создаем информационное окно
      const infoDiv = document.createElement('div');
      infoDiv.id = 'info';
      infoDiv.innerHTML = `
        <h3>AR Котики</h3>
        <p>Статус: <span id="status">Загрузка...</span></p>
        <p>Анимации: <span id="animations">Проверка...</span></p>
        <p>AR статус: <span id="ar-status">Ожидание...</span></p>
        <p>Управление:</p>
        <p>- Перетаскивание: Вращение</p>
        <p>- Двойной тап: Пауза/Воспроизведение</p>
      `;
      document.body.appendChild(infoDiv);

      // Загружаем модель
      const loader = new GLTFLoader();
      loader.load(
        './tell1.glb',
        function (gltf) {
          model = gltf.scene;
          model.scale.set(0.1, 0.1, 0.1);
          model.position.set(0, 0, 0); // Приземляем модель на пол
          model.rotation.y = Math.PI / 2; // Поворачиваем на 90 градусов влево
          scene.add(model);

          // Настраиваем анимации
          mixer = new THREE.AnimationMixer(model);
          animations = gltf.animations;
          if (animations && animations.length > 0) {
            currentAnimation = mixer.clipAction(animations[0]);
            currentAnimation.setLoop(THREE.LoopRepeat);
            currentAnimation.clampWhenFinished = false;
            currentAnimation.play();
          }
        },
        undefined,
        function (error) {
          console.error('Ошибка загрузки модели:', error);
        }
      );

      // Добавляем кнопку AR
      document.body.appendChild(ARButton.createButton(renderer));

      // Добавляем обработчики событий
      window.addEventListener('resize', onWindowResize, false);
      document.addEventListener('click', onDocumentClick, false);
    }

    function onWindowResize() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function onTouchStart(event) {
      event.preventDefault();
      isRotating = true;
      lastHitPosition = {
        x: event.touches[0].clientX,
        y: event.touches[0].clientY
      };
    }

    function onTouchMove(event) {
      event.preventDefault();
      if (!isRotating || !model) return;

      const touch = event.touches[0];
      const deltaX = touch.clientX - lastHitPosition.x;
      const deltaY = touch.clientY - lastHitPosition.y;

      model.rotation.y += deltaX * rotationSpeed;
      model.rotation.x += deltaY * rotationSpeed;

      // Ограничиваем вращение по X
      model.rotation.x = Math.max(-Math.PI/2, Math.min(Math.PI/2, model.rotation.x));

      lastHitPosition = {
        x: touch.clientX,
        y: touch.clientY
      };
    }

    function onTouchEnd(event) {
      event.preventDefault();
      isRotating = false;
    }

    function animate() {
      renderer.setAnimationLoop(function() {
        const currentTime = Date.now();
        const elapsedTime = (currentTime - startTime) / 1000;

        // Обновляем анимации
        if (mixer) {
          const delta = clock.getDelta();
          mixer.update(delta);
        }

        // Управляем движением модели
        if (model && renderer.xr.isPresenting) {
          if (!isLookingAtViewer) {
            // Движение влево-вправо
            if (currentDirection === 'left') {
              model.position.x -= moveSpeed;
              distanceTraveled += moveSpeed;
              
              if (distanceTraveled >= 3) {
                model.rotation.y = 0; // Поворачиваемся к зрителю
                isLookingAtViewer = true;
                lookAtViewerTime = currentTime;
                distanceTraveled = 0;
              }
            } else {
              model.position.x += moveSpeed;
              distanceTraveled += moveSpeed;
              
              if (distanceTraveled >= 6) {
                model.rotation.y = Math.PI; // Поворачиваемся к зрителю
                isLookingAtViewer = true;
                lookAtViewerTime = currentTime;
                distanceTraveled = 0;
              }
            }
          } else {
            // Проверяем время смотрения на зрителя
            if (currentTime - lookAtViewerTime >= 2000) { // 2 секунды
              isLookingAtViewer = false;
              if (currentDirection === 'left') {
                currentDirection = 'right';
                model.rotation.y = -Math.PI / 2; // Поворачиваемся вправо
              } else {
                currentDirection = 'left';
                model.rotation.y = Math.PI / 2; // Поворачиваемся влево
              }
            }
          }
        }

        // Обработка вращения в AR
        if (model && renderer.xr.isPresenting) {
          const rotationSpeed = 0.01;
          model.rotation.y += rotationSpeed;
        }

        renderer.render(scene, camera);
      });
    }
  </script>
</head>
<body>
</body>
</html>