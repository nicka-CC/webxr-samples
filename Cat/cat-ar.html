<!DOCTYPE html>
<html>
<head>
  <meta charset='utf-8'>
  <meta name='viewport' content='width=device-width, initial-scale=1'>
  <meta name='mobile-web-app-capable' content='yes'>
  <meta name='apple-mobile-web-app-capable' content='yes'>
  <title>AR Котики</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: black;
      overflow: hidden;
    }
    canvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
    }
    #info {
      position: fixed;
      top: 10px;
      left: 10px;
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 10px;
      border-radius: 5px;
      font-family: monospace;
      z-index: 3;
      font-size: 12px;
      max-width: 300px;
    }
    #info h3 {
      margin: 0 0 10px 0;
      color: #4CAF50;
    }
    #info p {
      margin: 5px 0;
    }
    #info .status {
      color: #4CAF50;
    }
    #info .error {
      color: #f44336;
    }
  </style>
  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
      }
    }
  </script>
  <script type="module">
    import * as THREE from 'three';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
    import { ARButton } from 'three/addons/webxr/ARButton.js';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

    let camera, scene, renderer;
    let model, mixer;
    let clock = new THREE.Clock();
    let currentAnimation = null;
    let animations = [];
    let isRotating = false;
    let lastRayPosition = null;
    let rotationSpeed = 5;

    init();
    animate();

    function init() {
      // Создаем сцену
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x000000);

      // Создаем камеру
      camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);
      camera.position.set(0, 1.6, 3);

      // Создаем рендерер
      renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      renderer.setPixelRatio(window.devicePixelRatio);
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.xr.enabled = true;
      document.body.appendChild(renderer.domElement);

      // Добавляем освещение
      const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1);
      light.position.set(0.5, 1, 0.25);
      scene.add(light);

      // Создаем информационное окно
      const infoDiv = document.createElement('div');
      infoDiv.id = 'info';
      infoDiv.innerHTML = `
        <h3>AR Котики</h3>
        <p>Статус: <span id="status">Загрузка...</span></p>
        <p>Анимации: <span id="animations">Проверка...</span></p>
        <p>Управление:</p>
        <p>- Тап: Сменить анимацию</p>
        <p>- Двойной тап: Пауза/Воспроизведение</p>
      `;
      document.body.appendChild(infoDiv);

      // Загружаем модель
      const loader = new GLTFLoader();
      loader.load(
        './untitled.glb',
        function (gltf) {
          model = gltf.scene;
          model.scale.set(0.1, 0.1, 0.1);
          scene.add(model);

          // Настраиваем анимации
          mixer = new THREE.AnimationMixer(model);
          animations = gltf.animations;
          
          if (animations && animations.length > 0) {
            document.getElementById('animations').textContent = `Найдено: ${animations.length}`;
            document.getElementById('status').textContent = 'Готово';
            
            // Запускаем первую анимацию
            currentAnimation = mixer.clipAction(animations[0]);
            currentAnimation.play();
          } else {
            document.getElementById('animations').textContent = 'Не найдено';
            document.getElementById('status').textContent = 'Нет анимаций';
          }
        },
        function (xhr) {
          document.getElementById('status').textContent = `Загрузка: ${(xhr.loaded / xhr.total * 100).toFixed(0)}%`;
        },
        function (error) {
          document.getElementById('status').textContent = 'Ошибка загрузки';
          console.error(error);
        }
      );

      // Добавляем кнопку AR
      document.body.appendChild(ARButton.createButton(renderer));

      // Настраиваем WebXR
      renderer.xr.addEventListener('sessionstart', function() {
        console.log('AR сессия началась');
      });

      renderer.xr.addEventListener('sessionend', function() {
        console.log('AR сессия закончилась');
        isRotating = false;
        lastRayPosition = null;
      });

      // Обработка жестов в AR
      renderer.xr.addEventListener('selectstart', function() {
        isRotating = true;
        console.log('Начало вращения');
      });

      renderer.xr.addEventListener('selectend', function() {
        isRotating = false;
        lastRayPosition = null;
        console.log('Конец вращения');
      });

      // Обработка движения в AR
      renderer.xr.addEventListener('inputsourceschange', function(event) {
        event.added.forEach((inputSource) => {
          inputSource.addEventListener('selectstart', () => {
            isRotating = true;
            console.log('Начало вращения');
          });
          inputSource.addEventListener('selectend', () => {
            isRotating = false;
            lastRayPosition = null;
            console.log('Конец вращения');
          });
        });
      });

      // Обработка жестов для анимаций
      let lastTapTime = 0;
      renderer.domElement.addEventListener('click', function(event) {
        const currentTime = new Date().getTime();
        const tapLength = currentTime - lastTapTime;
        
        if (tapLength < 300 && tapLength > 0) {
          // Двойной тап - пауза/воспроизведение
          if (currentAnimation) {
            if (currentAnimation.isRunning()) {
              currentAnimation.stop();
            } else {
              currentAnimation.play();
            }
          }
        } else {
          // Одинарный тап - следующая анимация
          if (animations && animations.length > 0) {
            const currentIndex = animations.indexOf(currentAnimation.getClip());
            const nextIndex = (currentIndex + 1) % animations.length;
            currentAnimation = mixer.clipAction(animations[nextIndex]);
            currentAnimation.play();
          }
        }
        
        lastTapTime = currentTime;
      });

      // Обработка изменения размера окна
      window.addEventListener('resize', onWindowResize);
    }

    function onWindowResize() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function animate() {
      renderer.setAnimationLoop(function() {
        if (mixer) {
          mixer.update(clock.getDelta());
        }

        // Обработка вращения в AR
        if (isRotating && model && renderer.xr.isPresenting) {
          const session = renderer.xr.getSession();
          if (session) {
            const inputSources = session.inputSources;
            inputSources.forEach((source) => {
              if (source.targetRaySpace) {
                const targetRayPose = renderer.xr.getReferenceSpace().getPose(source.targetRaySpace);
                if (targetRayPose) {
                  const position = targetRayPose.transform.position;
                  
                  if (lastRayPosition) {
                    const deltaX = position.x - lastRayPosition.x;
                    const deltaY = position.y - lastRayPosition.y;
                    
                    model.rotation.y += deltaX * rotationSpeed;
                    model.rotation.x += deltaY * rotationSpeed;
                    
                    // Ограничиваем вращение по X
                    model.rotation.x = Math.max(-Math.PI/2, Math.min(Math.PI/2, model.rotation.x));
                    
                    console.log(`Вращение: X=${deltaX.toFixed(2)}, Y=${deltaY.toFixed(2)}`);
                  }
                  
                  lastRayPosition = position;
                }
              }
            });
          }
        }

        renderer.render(scene, camera);
      });
    }
  </script>
</head>
<body>
</body>
</html>