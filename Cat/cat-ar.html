<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <meta name='mobile-web-app-capable' content='yes'>
    <meta name='apple-mobile-web-app-capable' content='yes'>
    <title>AR Котики</title>
    <link rel='stylesheet' href='../css/stylesheet.css'>
    <link rel='stylesheet' href='../css/pygment_trac.css'>
    <script type="module">
      import {WebXRButton} from '../js/util/webxr-button.js';
      import {Scene} from '../js/render/scenes/scene.js';
      import {Renderer, createWebGLContext} from '../js/render/core/renderer.js';
      import {Gltf2Node} from '../js/render/nodes/gltf2.js';
      import {DropShadowNode} from '../js/render/nodes/drop-shadow.js';
      import {vec3} from '../js/render/math/gl-matrix.js';
      import {QueryArgs} from '../js/util/query-args.js';

      // Если требуется, используем полифилл для поддержки мобильных устройств
      import WebXRPolyfill from '../js/third-party/webxr-polyfill/build/webxr-polyfill.module.js';
      if (QueryArgs.getBool('usePolyfill', true)) {
        let polyfill = new WebXRPolyfill();
      }

      // XR глобальные переменные
      let xrButton = null;
      let xrRefSpace = null;
      let xrHitTestSource = null;

      // WebGL глобальные переменные
      let gl = null;
      let renderer = null;
      let scene = new Scene();
      scene.enableStats(false);

      // Создаем AR сцену
      class ARCatScene {
        constructor() {
          // Загружаем модель кота
          this.cat = new Gltf2Node({url: './Cat.fbx'});
          this.cat.scale = [0.1, 0.1, 0.1]; // Уменьшаем размер для удобства
          scene.addNode(this.cat);

          // Добавляем ретикул для указания места размещения
          this.reticle = new Gltf2Node({url: '../media/gltf/reticle/reticle.gltf'});
          this.reticle.visible = false;
          scene.addNode(this.reticle);

          // Добавляем тень под котом
          this.shadow = new DropShadowNode();
          vec3.set(this.shadow.scale, 0.15, 0.15, 0.15);
          this.cat.addNode(this.shadow);

          this.MAX_CATS = 30;
          this.cats = [];
        }

        addCatAt(matrix) {
          let newCat = this.cat.clone();
          newCat.visible = true;
          newCat.matrix = matrix;
          scene.addNode(newCat);

          this.cats.push(newCat);

          if (this.cats.length > this.MAX_CATS) {
            let oldCat = this.cats.shift();
            scene.removeNode(oldCat);
          }
        }

        update(frame, refSpace) {
          this.reticle.visible = false;

          if (frame) {
            let hitTestResults = frame.getHitTestResults(xrHitTestSource);
            if (hitTestResults.length > 0) {
              let hit = hitTestResults[0];
              let pose = hit.getPose(refSpace);
              this.reticle.visible = true;
              this.reticle.matrix = pose.transform.matrix;
            }
          }
        }
      }

      // Создаем экземпляр AR сцены
      let arScene = new ARCatScene();

      // Делаем фон прозрачным для AR
      scene.clear = false;

      function initXR() {
        xrButton = new WebXRButton({
          onRequestSession: onRequestSession,
          onEndSession: onEndSession,
          textEnterXRTitle: "START AR",
          textXRNotFoundTitle: "AR NOT FOUND",
          textExitXRTitle: "EXIT AR",
        });
        document.querySelector('header').appendChild(xrButton.domElement);

        if (navigator.xr) {
          navigator.xr.isSessionSupported('immersive-ar').then((supported) => {
            xrButton.enabled = supported;
          });
        }
      }

      function onRequestSession() {
        let sessionInit = {
          requiredFeatures: ['hit-test'],
          optionalFeatures: ['dom-overlay'],
          domOverlay: { root: document.body }
        };

        navigator.xr.requestSession('immersive-ar', sessionInit)
          .then((session) => {
            xrButton.setSession(session);
            onSessionStarted(session);
          });
      }

      function onSessionStarted(session) {
        session.addEventListener('end', onSessionEnded);

        let canvas = document.createElement('canvas');
        gl = canvas.getContext('webgl', { xrCompatible: true });
        document.body.appendChild(gl.canvas);
        renderer = new Renderer(gl);
        scene.setRenderer(renderer);

        session.updateRenderState({
          baseLayer: new XRWebGLLayer(session, gl)
        });

        session.requestReferenceSpace('local').then((refSpace) => {
          xrRefSpace = refSpace;
          session.requestAnimationFrame(onXRFrame);
        });

        session.requestHitTestSource({ space: xrRefSpace }).then((source) => {
          xrHitTestSource = source;
        });

        session.addEventListener('select', onSelect);
      }

      function onEndSession(session) {
        xrHitTestSource.cancel();
        xrHitTestSource = null;
        session.end();
      }

      function onSessionEnded(event) {
        xrButton.setSession(null);
      }

      function onSelect(event) {
        if (arScene.reticle.visible) {
          arScene.addCatAt(arScene.reticle.matrix);
        }
      }

      function onXRFrame(t, frame) {
        let session = frame.session;
        let pose = frame.getViewerPose(xrRefSpace);

        // Обновляем AR сцену
        arScene.update(frame, xrRefSpace);

        scene.startFrame();
        scene.drawXRFrame(frame, pose);
        scene.endFrame();

        session.requestAnimationFrame(onXRFrame);
      }

      // Инициализация
      initXR();
    </script>
  </head>
  <body>
    <header>
      <details open>
        <summary>AR Котики</summary>
        <p>
          Размещайте виртуальных котов в реальном мире с помощью AR.
          <a class="back" href="../">Назад</a>
        </p>
      </details>
    </header>
  </body>
</html> 