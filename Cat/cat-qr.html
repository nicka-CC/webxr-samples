<!DOCTYPE html>
<html>
<head>
  <title>AR.js + three.js WebAR Cat</title>
  <script src="https://cdn.jsdelivr.net/npm/three@0.125.2/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.125.2/examples/js/loaders/GLTFLoader.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/three.js/build/ar-threex.js"></script>
  <style>
    body { margin: 0; overflow: hidden; }
  </style>
</head>
<body>
<script>
  let scene, camera, renderer, clock, mixer, model;

  // 1. Сцена и камера
  scene = new THREE.Scene();
  camera = new THREE.Camera();
  scene.add(camera);

  // 2. Рендерер
  renderer = new THREE.WebGLRenderer({antialias: true, alpha: true});
  renderer.setClearColor(0x000000, 0);
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.domElement.style.position = 'absolute';
  renderer.domElement.style.top = '0px';
  renderer.domElement.style.left = '0px';
  document.body.appendChild(renderer.domElement);

  // 3. AR.js Source (камера)
  let arSource = new THREEx.ArToolkitSource({ sourceType: 'webcam' });
  arSource.init(function onReady() {
    onResize();
  });
  window.addEventListener('resize', function() {
    onResize();
  });
  function onResize() {
    arSource.onResizeElement();
    arSource.copyElementSizeTo(renderer.domElement);
    if (arContext.arController !== null) {
      arSource.copyElementSizeTo(arContext.arController.canvas);
    }
  }

  // 4. AR.js Context (используем локальный camera_para.dat)
  let arContext = new THREEx.ArToolkitContext({
    cameraParametersUrl: 'camera_para.dat',
    detectionMode: 'mono'
  });
  arContext.init(function onCompleted() {
    camera.projectionMatrix.copy(arContext.getProjectionMatrix());
  });

  // 5. Маркер
  let markerRoot = new THREE.Group();
  scene.add(markerRoot);
  let arMarker = new THREEx.ArMarkerControls(arContext, markerRoot, {
    type: 'pattern',
    patternUrl: 'pattern-qr.patt' // ваш паттерн
    // или preset: 'hiro'
  });

  // 6. Свет
  let light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1);
  markerRoot.add(light);

  // 7. Загрузка модели с анимацией
  clock = new THREE.Clock();
  let loader = new THREE.GLTFLoader();
  loader.load('walk3.glb', function(gltf) {
    model = gltf.scene;
    model.scale.set(0.2, 0.2, 0.2);
    markerRoot.add(model);

    // Анимация
    if (gltf.animations && gltf.animations.length > 0) {
      mixer = new THREE.AnimationMixer(model);
      let action = mixer.clipAction(gltf.animations[0]);
      action.play();
    }
  });

  // 8. Рендер-цикл
  function animate() {
    requestAnimationFrame(animate);
    if (arSource.ready) arContext.update(arSource.domElement);
    if (mixer) mixer.update(clock.getDelta());
    renderer.render(scene, camera);
  }
  animate();
</script>
</body>
</html>