<!DOCTYPE html>
<html>
<head>
  <title>three.js + AR.js без маркеров</title>
  <script src="https://cdn.jsdelivr.net/npm/three@0.125.2/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.125.2/examples/js/loaders/GLTFLoader.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/three.js/build/ar-threex.js"></script>
  <style>
    html, body { margin: 0; padding: 0; width: 100vw; height: 100vh; overflow: hidden; background: #000; }
    canvas, video, #arjs-video {
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      width: 100vw !important;
      height: 100vh !important;
      object-fit: cover !important;
      z-index: 1;
    }
  </style>
</head>
<body>
<script>
  let scene, camera, renderer, clock, mixer, model;

  // 1. Сцена и камера
  scene = new THREE.Scene();
  camera = new THREE.Camera();
  scene.add(camera);

  // 2. Рендерер
  renderer = new THREE.WebGLRenderer({antialias: true, alpha: true});
  renderer.setClearColor(0x000000, 0);
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.domElement.style.position = 'fixed';
  renderer.domElement.style.top = '0';
  renderer.domElement.style.left = '0';
  renderer.domElement.style.width = '100vw';
  renderer.domElement.style.height = '100vh';
  document.body.appendChild(renderer.domElement);

  // 3. AR.js Source (камера)
  let arSource = new THREEx.ArToolkitSource({ sourceType: 'webcam' });
  arSource.init(function onReady() {
    onResize();
    setTimeout(() => {
      const arVideo = document.querySelector('video, #arjs-video');
      if (arVideo) {
        arVideo.style.position = 'fixed';
        arVideo.style.top = '0';
        arVideo.style.left = '0';
        arVideo.style.width = '100vw';
        arVideo.style.height = '100vh';
        arVideo.style.objectFit = 'cover';
        arVideo.style.zIndex = '0';
      }
    }, 1000);
  });
  window.addEventListener('resize', function() {
    onResize();
  });
  function onResize() {
    arSource.onResizeElement();
    arSource.copyElementSizeTo(renderer.domElement);
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.domElement.style.width = '100vw';
    renderer.domElement.style.height = '100vh';
  }

  // 4. AR.js Context (используем локальный camera_para.dat)
  let arContext = new THREEx.ArToolkitContext({
    cameraParametersUrl: 'camera_para.dat',
    detectionMode: 'mono'
  });
  arContext.init(function onCompleted() {
    camera.projectionMatrix.copy(arContext.getProjectionMatrix());
  });

  // 5. Свет
  let light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1);
  scene.add(light);
  let dirLight = new THREE.DirectionalLight(0xffffff, 0.7);
  dirLight.position.set(1, 2, 1);
  scene.add(dirLight);

  // 6. Загрузка модели с анимацией
  clock = new THREE.Clock();
  let loader = new THREE.GLTFLoader();
  loader.load('walk3.glb', function(gltf) {
    model = gltf.scene;
    model.scale.set(0.2, 0.2, 0.2);
    model.position.set(0, 0, -10); // 1 метр перед камерой
    scene.add(model);

    // Анимация
    if (gltf.animations && gltf.animations.length > 0) {
      mixer = new THREE.AnimationMixer(model);
      let action = mixer.clipAction(gltf.animations[0]);
      action.play();
    }
  });

  // 7. Рендер-цикл
  function animate() {
    requestAnimationFrame(animate);
    if (arSource.ready) arContext.update(arSource.domElement);
    if (mixer) mixer.update(clock.getDelta());
    renderer.render(scene, camera);
  }
  animate();

  // 8. Адаптация под размер окна
  window.addEventListener('resize', function() {
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.domElement.style.width = '100vw';
    renderer.domElement.style.height = '100vh';
  });
</script>
</body>
</html>