<!DOCTYPE html>
<html>
<head>
  <title>three.js + AR.js без маркеров (естественный размер)</title>
  <script src="https://cdn.jsdelivr.net/npm/three@0.125.2/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.125.2/examples/js/loaders/GLTFLoader.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/three.js/build/ar-threex.js"></script>
  <meta charset="utf-8">
  <style>
    html, body { margin: 0; padding: 0; width: 100vw; height: 100vh; overflow: hidden; background: #000; }
    canvas, video, #arjs-video {
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      margin: 0 !important;
      width: 100vw !important;
      height: 100vh !important;
      object-fit: cover !important;
      z-index: 1;
    }
  </style>
</head>
<body>
<audio id="cat-audio" src="hhhh.mp3" preload="auto"></audio>
<script>
  let scene, camera, renderer, clock, mixer, model;

  // 1. Сцена и камера
  scene = new THREE.Scene();
  camera = new THREE.PerspectiveCamera(30, window.innerWidth / window.innerHeight, 0.1, 100);
  camera.position.set(0, 1, 3);
  scene.add(camera);

  // 2. Рендерер
  renderer = new THREE.WebGLRenderer({antialias: true, alpha: true});
  renderer.setClearColor(0x000000, 0);
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.domElement.style.position = 'fixed';
  renderer.domElement.style.top = '0';
  renderer.domElement.style.left = '0';
  renderer.domElement.style.width = '100vw';
  renderer.domElement.style.height = '100vh';
  document.body.appendChild(renderer.domElement);

  // 3. AR.js Source (камера)
  let arSource = new THREEx.ArToolkitSource({ sourceType: 'webcam' });
  arSource.init(function onReady() {
    onResize();
    setTimeout(() => {
      const arVideo = document.querySelector('video, #arjs-video');
      if (arVideo) {
        arVideo.style.position = 'fixed';
        arVideo.style.top = '0';
        arVideo.style.left = '0';
        arVideo.style.width = '100vw';
        arVideo.style.height = '100vh';
        arVideo.style.objectFit = 'cover';
        arVideo.style.zIndex = '0';
      }
    }, 1000);
  });
  window.addEventListener('resize', function() {
    onResize();
    updateModelScale();
  });
  function onResize() {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.domElement.style.width = '100vw';
    renderer.domElement.style.height = '100vh';
    arSource.onResizeElement();
    arSource.copyElementSizeTo(renderer.domElement);
    // Масштабируем видео с камеры
    const arVideo = document.querySelector('video, #arjs-video');
    if (arVideo) {
      arVideo.style.width = '100vw';
      arVideo.style.height = '100vh';
      arVideo.style.objectFit = 'cover';
    }
  }

  // 4. AR.js Context (используем локальный camera_para.dat)
  let arContext = new THREEx.ArToolkitContext({
    cameraParametersUrl: 'camera_para.dat',
    detectionMode: 'mono'
  });
  arContext.init(function onCompleted() {
    camera.projectionMatrix.copy(arContext.getProjectionMatrix());
  });

  // 5. Свет
  const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1);
  light.position.set(0.5, 1, 0.25);
  scene.add(light);

  const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
  directionalLight.position.set(1, 1, 1);
  scene.add(directionalLight);

  const ambient = new THREE.AmbientLight(0xffffff, 1.2);
  // scene.add(ambient);
  // 6. Загрузка модели с анимацией
  clock = new THREE.Clock();
  let loader = new THREE.GLTFLoader();

  function updateModelScale() {
    const baseWidth = 400;
    const scale = Math.max(0.15, Math.min(0.5, window.innerWidth / baseWidth * 0.1));
    if (model) model.scale.set(scale, scale, scale);
  }

  loader.load('Cate.glb', function(gltf) {
    model = gltf.scene;
    model.position.set(0.00625 * window.innerWidth / 10, 0, -13);
    updateModelScale();

    // Настройка материалов и теней как в firstCat.html + фикс прозрачности как в secondCat.html
    model.traverse((child) => {
      if (child.isMesh && child.material) {
        child.material.roughness = 1.0;
        child.material.metalness = 0.0;
        child.material.envMapIntensity = 0.0;
        child.material.needsUpdate = true;
        child.castShadow = true;
        child.receiveShadow = true;
        // Фикс для прозрачных частей (рот, глаза, зрачки, радужка)
        const n = child.name.toLowerCase();
        if (n.includes('mouth') || n.includes('eye') || n.includes('pupil') || n.includes('iris')) {
          child.material.transparent = true;
          child.material.depthWrite = false;
          child.material.depthTest = true;
          child.material.needsUpdate = true;
        }
      }
    });
    scene.add(model);

    // Анимации: запускаем все клипы сразу (как в secondCat.html)
    if (gltf.animations && gltf.animations.length > 0) {
      mixer = new THREE.AnimationMixer(model);
      gltf.animations.forEach((clip) => {
        const action = mixer.clipAction(clip);
        action.setLoop(THREE.LoopRepeat);
        action.clampWhenFinished = false;
        action.play();
      });
    }
  });

  // 7. Рендер-цикл
  function animate() {
    requestAnimationFrame(animate);
    if (arSource.ready) arContext.update(arSource.domElement);
    if (mixer) mixer.update(clock.getDelta());
    renderer.render(scene, camera);
  }
  animate();

  const audio = document.getElementById('cat-audio');
  function playCatSoundOnce() {
    audio.play();
    window.removeEventListener('pointerdown', playCatSoundOnce);
  }
  window.addEventListener('pointerdown', playCatSoundOnce);
</script>
</body>
</html>